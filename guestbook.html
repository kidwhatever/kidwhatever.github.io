<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Touryouka's Guestbook</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCMjbke0B0HFGyIBG9EAqHN54Bl63lQV-Q",
            authDomain: "guestbook-f36d5.firebaseapp.com",
            projectId: "guestbook-f36d5",
            storageBucket: "guestbook-f36d5.appspot.com",
            messagingSenderId: "250167404792",
            appId: "1:250167404792:web:16f578c1712cbf7ebff30d",
            measurementId: "G-TZVEFCTQHZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Initialize Firestore

        // Function to handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('guestbook-form');

            form.addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent form from submitting in the default way
                
                // Get form values
                const name = document.getElementById('name').value;
                const message = document.getElementById('message').value;

                // Send data to Firestore
                try {
                    await addDoc(collection(db, "guestbook"), {
                        name: name,
                        message: message,
                        timestamp: new Date() // Using JavaScript date object directly
                    });
                    alert("Thank you for signing the guestbook!");

                    // Optionally, reset the form
                    form.reset();
                    loadMessages(); // Reload messages after submission
                } catch (error) {
                    console.error("Error submitting to Firestore: ", error);
                    alert("Error submitting your message. Please try again.");
                }
            });

            loadMessages(); // Load messages when the page is first loaded
        });

        // Function to load messages from Firestore
        async function loadMessages() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '<p>Loading messages...</p>'; // Show loading message

            try {
                const querySnapshot = await getDocs(collection(db, "guestbook"));
                const messages = []; // Array to hold messages

                querySnapshot.forEach((doc) => {
                    const messageData = doc.data();
                    console.log(messageData); // Log the message data for debugging
                    
                    // Check the type of timestamp
                    if (messageData.timestamp && messageData.timestamp.toDate) {
                        const timestamp = messageData.timestamp.toDate(); // Convert to Date object
                        messages.push({
                            name: messageData.name,
                            message: messageData.message,
                            timestamp: timestamp
                        });
                    } else {
                        console.warn("Timestamp is not a Firestore Timestamp:", messageData.timestamp);
                    }
                });

                // Sort messages by timestamp in descending order
                messages.sort((a, b) => b.timestamp - a.timestamp);

                // Clear previous messages
                messagesContainer.innerHTML = ''; 

                // Check if there are messages and append them to the container
                if (messages.length === 0) {
                    messagesContainer.innerHTML = '<p>No messages yet.</p>';
                } else {
                    messages.forEach(messageData => {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('message');
                        messageElement.innerHTML = `
                            <strong>${messageData.name}</strong> <small>${messageData.timestamp.toLocaleString()}</small>
                            <p>${messageData.message}</p>
                            <hr>
                        `;
                        messagesContainer.appendChild(messageElement);
                    });
                }
            } catch (error) {
                console.error("Error loading messages: ", error);
                messagesContainer.innerHTML = `<p>Error loading messages: ${error.message}. Please try again later.</p>`;
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="hd.png" alt="Header Image" class="header-image">
        </header>

        <!-- Guestbook form -->
        <section class="main">
            <h2>Sign the Guestbook!!! :3</h2>
            <form id="guestbook-form">
                <input type="text" id="name" placeholder="Your Name" required>
                <br><br>
                <textarea id="message" placeholder="Your Message" rows="5" required></textarea>
                <br><br>
                <button type="submit">Submit</button>
            </form>

            <!-- Display messages -->
            <h2>Messages</h2>
            <div id="messages"></div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Â© 2024 Touryouka. All Rights Reserved.</p>
        </footer>
    </div>
</body>
</html>
